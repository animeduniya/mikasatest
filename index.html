<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AnimeStream</title>
  <style>
    body { background: #1e1e1e; color: white; font-family: sans-serif; padding: 20px; }
    input { padding: 10px; width: 100%; margin-bottom: 20px; }
    .anime-card { background: #2c2c2c; padding: 10px; margin: 10px 0; border-radius: 8px; }
    iframe { width: 100%; height: 400px; border: none; }
  </style>
</head>
<body>
  <h1>AnimeStream</h1>
  <input type="text" id="searchInput" placeholder="Search anime..." />
  <div id="animeList"></div>
  <div id="episodes"></div>
  <div id="player"></div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const animeList = document.getElementById('animeList');
    const episodesDiv = document.getElementById('episodes');
    const player = document.getElementById('player');

    async function fetchAnime(query) {
      animeList.innerHTML = 'Searching...';
      const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://anitaku.to/search.html?keyword=${query}`)}`;
      const res = await fetch(url);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const results = [...doc.querySelectorAll('.last_episodes li')];
      animeList.innerHTML = results.map(anime => {
        const title = anime.querySelector('.name').textContent.trim();
        const link = anime.querySelector('a').href;
        const img = anime.querySelector('img').src;
        return `<div class="anime-card">
          <h3>${title}</h3>
          <img src="${img}" width="150"/><br/>
          <button onclick="loadEpisodes('${link}')">View Episodes</button>
        </div>`;
      }).join('');
    }

    async function loadEpisodes(animeUrl) {
      episodesDiv.innerHTML = 'Loading episodes...';
      const corsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(animeUrl)}`;
      const res = await fetch(corsUrl);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const epLinks = [...doc.querySelectorAll('.episodelist ul li a')];
      episodesDiv.innerHTML = epLinks.reverse().map(ep => {
        const epName = ep.textContent.trim();
        const epLink = ep.href;
        return `<button onclick="loadPlayer('${epLink}')">${epName}</button>`;
      }).join('<br/>');
    }

    async function loadPlayer(episodeUrl) {
      player.innerHTML = 'Loading stream...';
      const corsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(episodeUrl)}`;
      const res = await fetch(corsUrl);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const iframe = doc.querySelector('iframe');
      if (iframe) {
        player.innerHTML = `<h3>Now Streaming:</h3><iframe src="${iframe.src}" allowfullscreen></iframe>`;
      } else {
        player.innerHTML = 'Streaming link not found.';
      }
    }

    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') fetchAnime(searchInput.value);
    });

    // Optional: load trending on start
    fetchAnime('one piece');
  </script>
</body>
</html>
