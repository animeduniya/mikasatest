<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manga Reader (Live Search)</title>
  <style>
    body {
      background: #1e1e1e;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 16px;
      border-radius: 6px;
    }
    img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
    .chapter-images img {
      margin-bottom: 20px;
    }
    .cover {
      width: 200px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .search-results {
      margin-top: 10px;
    }
    .search-item {
      padding: 10px;
      background: #333;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 6px;
    }
    .search-item:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Manga Reader ðŸ“–</h1>
    <input type="text" id="searchInput" placeholder="Type Manga Name..." oninput="searchManga()">
    <div id="searchResults" class="search-results"></div>

    <h2>Manga Details</h2>
    <div id="mangaDetails"></div>

    <h2>Chapter Pages</h2>
    <div id="chapterPages" class="chapter-images"></div>
  </div>

  <script>
    let timeout = null;

    async function searchManga() {
      clearTimeout(timeout);
      timeout = setTimeout(async () => {
        const query = document.getElementById('searchInput').value.trim();
        const searchResults = document.getElementById('searchResults');
        searchResults.innerHTML = '';

        if (!query) return;

        try {
          const anilistQuery = `
            query ($search: String) {
              Page(perPage: 5) {
                media(search: $search, type: MANGA) {
                  id
                  title {
                    romaji
                    english
                    native
                  }
                  coverImage {
                    medium
                  }
                }
              }
            }
          `;

          const response = await fetch('https://graphql.anilist.co', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: anilistQuery,
              variables: { search: query }
            })
          });

          const data = await response.json();
          const mangas = data.data.Page.media;

          mangas.forEach(manga => {
            const item = document.createElement('div');
            item.className = 'search-item';
            item.innerHTML = `
              <img src="${manga.coverImage.medium}" alt="cover" style="height:50px;vertical-align:middle;margin-right:10px;">
              ${manga.title.romaji || manga.title.english || manga.title.native}
            `;
            item.onclick = () => loadManga(manga);
            searchResults.appendChild(item);
          });
        } catch (error) {
          console.error('Search Error:', error);
          searchResults.innerHTML = '<p>Error loading search results.</p>';
        }
      }, 400); // Delay typing by 400ms
    }

    async function loadManga(manga) {
      document.getElementById('mangaDetails').innerHTML = 'Loading manga details...';
      document.getElementById('chapterPages').innerHTML = '';
      document.getElementById('searchResults').innerHTML = '';

      try {
        // Load manga details
        const anilistQuery = `
          query ($id: Int) {
            Media(id: $id, type: MANGA) {
              title {
                romaji
                english
                native
              }
              description(asHtml: false)
              coverImage {
                large
              }
            }
          }
        `;

        const response = await fetch('https://graphql.anilist.co', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: anilistQuery,
            variables: { id: manga.id }
          })
        });

        const data = await response.json();
        const mangaDetails = data.data.Media;

        document.getElementById('mangaDetails').innerHTML = `
          <h2>${mangaDetails.title.romaji || mangaDetails.title.english || mangaDetails.title.native}</h2>
          <img class="cover" src="${mangaDetails.coverImage.large}" alt="Manga Cover">
          <p>${mangaDetails.description || 'No description available.'}</p>
        `;

        // Now load chapter images (for now, dummy chapter CID or you can link a real one)
        const mangaName = manga.title.romaji || manga.title.english || manga.title.native;
        const dummyCid = "dd6ab2dd-115b-4ee5-bf9f-d2f210e4e5a4"; // <-- You can update dynamically if you have chapter info

        try {
          const chapterResponse = await fetch(`https://jimov-api.vercel.app/manga/inmanga/chapter/${encodeURIComponent(mangaName)}?cid=${dummyCid}`);
          const chapterData = await chapterResponse.json();

          if (!chapterData.images || chapterData.images.length === 0) {
            document.getElementById('chapterPages').innerHTML = '<p>No images found for this chapter.</p>';
            return;
          }

          chapterData.images.forEach(image => {
            const img = document.createElement('img');
            img.src = image.url;
            document.getElementById('chapterPages').appendChild(img);
          });
        } catch (error) {
          console.error('Chapter fetch error:', error);
          document.getElementById('chapterPages').innerHTML = '<p>Error loading chapter pages.</p>';
        }

      } catch (error) {
        console.error('Manga fetch error:', error);
        document.getElementById('mangaDetails').innerHTML = '<p>Error loading manga details.</p>';
      }
    }
  </script>
</body>
</html>
